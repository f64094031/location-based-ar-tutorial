<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>demo</title>
    <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script>
        THREEx.ArToolkitContext.baseURL = 'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/'
    </script>
    <link rel="stylesheet" type="text/css" href="./test.css"/>
	  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!--ArcGIS API-->
	  <link rel="stylesheet" href="https://js.arcgis.com/4.13/esri/css/main.css">
	  <script src="https://js.arcgis.com/4.13/"></script>

    <!-- 加入屬性和... -->
    <script>
			AFRAME.registerComponent('blood', {
			schema: {
				blood_type: {type: "string", default: "O-type"}, 
				oxygen_level: {type: "string", default: "normal"}
			},
			init: function () {
				//列出這個data屬性
				console.log(this.data);
				//列出這個element資料
				console.log(this.el);
				let Chang = document.querySelector('#Tank');			
				console.log(Chang);

				let data = this.data;
				
				//加入event listener
				this.el.addEventListener('click', function(obj){
					//列出data屬性
					console.log(data);
					//列出element背後的資料
					console.log(obj);
					let oldPosition = obj.srcElement.getAttribute('position');
					console.log(oldPosition);

					//改變element的位置
					let newPositionY = oldPosition.y + 0.2;
					obj.srcElement.setAttribute('position', oldPosition.x + " " + newPositionY + " " + oldPosition.z );

				});

			},
			update: function () {},
			tick: function () {},
			remove: function () {},
			pause: function () {},
			play: function () {}
		});
		</script>

    <style>
		html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
	</style>
</head>

<body style='margin: 0; overflow: hidden;'>
  <div id="apidata"
    onmouseover="over(this);"
		onmouseout="out(this);"
		onmousedown="down(this);"
		onmouseup="up(this);"><p>資料</p>
  </div>

<script>
	function over(elem){
		elem.style.backgroundColor="#ddaaaa";
	}
	function out(elem){
		elem.style.backgroundColor="#ffcccc";
	}
	function down(elem){
    fetch("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=4dcde793-5890-4f3e-af67-58a652e0a1fc&filters=county,EQ,%E8%87%BA%E5%8D%97%E5%B8%82").then(function(response){
					//https://data.epa.gov.tw/api/v2/aqx_p_149?format=json&language=zh&api_key=4dcde793-5890-4f3e-af67-58a652e0a1fc
					return response.json();
				}).then(function(data){
					console.log(data);
					let one=data;
					console.log(one.records[3].status);
					document.getElementById("apidata").innerHTML ="<div>" + "測站名稱:" + one.records[3].sitename + "<br>"
                                                                + "縣市 " + one.records[3].county + "<br>"
                                                                + "空氣品質指標 " + one.records[3].aqi + "<br>" 
                                                                + "狀態 " + one.records[3].status + "<br>"
                                                                + "二氧化硫（ppb） " + one.records[3].so2 + "<br>"
                                                                + "一氧化碳（ppm） " + one.records[3].co + "<br>"
                                                                + "臭氧（ppb） " + one.records[3].o3 + "<br>"
                                                                + "臭氧8小時移動平均（ppb） " + one.records[3].o3_8hr + "<br>"
                                                                + "懸浮微粒（μg\/m3） " + one.records[3].pm10 + "<br>" 
                                                                + "細懸浮微粒（μg\/m3） " + one.records[3]["pm2.5"] + "<br>" 
                                                                + "二氧化氮（ppb） " + one.records[3]["no2"] + "<br>" 
                                                                + "氮氧化物（ppb） " + one.records[3]["nox"] + "<br>" 
                                                                + "一氧化氮（ppb） " + one.records[3]["no"] + "<br>" 
                                                                + "風速（m\/sec） " + one.records[3]["wind_speed"] + "<br>" 
                                                                + "資料發布時間 " + one.records[3]["publishtime"] + "<div>";
        });
    
	}
	function up(elem){
    getdata();
		elem.style.fontWeight="normal";
    document.getElementById("apidata").innerHTML ="<div>" + "空氣品質資料:" + one.records[3].sitename + ": " + one.records[3].status + "<div>";
	}
</script>  
  <button class="button abc" onclick="getdata()">獲取資料</button>
  <script>
    function getdata(){
				fetch("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=4dcde793-5890-4f3e-af67-58a652e0a1fc&filters=county,EQ,%E8%87%BA%E5%8D%97%E5%B8%82").then(function(response){
					//https://data.epa.gov.tw/api/v2/aqx_p_149?format=json&language=zh&api_key=4dcde793-5890-4f3e-af67-58a652e0a1fc
					return response.json();
				}).then(function(data){
					console.log(data);
					let one=data;
					console.log(one.records[3].status);
					document.getElementById("apidata").innerHTML ="<div>" + "空氣品質資料" + "<br>" + one.records[3].sitename + ": " + one.records[3].status + "<div>";
				});
    }
</script>

    <a-scene
        vr-mode-ui="enabled: false"
		    embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>
        
        <a-assets>
            <img id = "P1" src="./pic/texture.png">
            <img id="arrow" src="./pic/arrow.png">
						<a-assets-item id="nav" src="./assets/nav/nav4.gltf"></a-assets-item>
            <a-assets-item id="articuno" src="./assets/articuno/scene.gltf"></a-assets-item>
            <a-assets-item id="dragonite" src="./assets/dragonite/scene.gltf"></a-assets-item>
        </a-assets>
        
        <a-image src="#P1" rotation="0 180 0" scale="0.15 0.15 0.15" side="double" 
          gps-entity-place="longitude: 120.220086; latitude: 22.998544;" >
        </a-image>

        <!-- <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.217926; latitude: 23.008419;" >
        </a-image> -->

        <a-image src="#arrow" rotation="-90 -100 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.21962339676706; latitude: 22.998394890831605;" 
          width="2" 
          height="55" 			                
			    repeat = "1 55" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.21998201488613; latitude: 22.998517385777983;" 
          width="2" 
          height="20" 			                
			    repeat = "1 20" >
        </a-image> 

        <!-- <a-image src="#arrow" rotation="-90 90 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219994; latitude: 22.998558;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 90 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219986; latitude: 22.998477;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 90 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219975; latitude: 22.998373;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219881; latitude: 22.998383;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219795; latitude: 22.998388;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219704; latitude: 22.998394;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219611; latitude: 22.998401;" >
        </a-image> 
        
        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219519; latitude: 22.998406;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219422; latitude: 22.998411;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219318; latitude: 22.998416;" >
        </a-image> 

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219212; latitude: 22.998425;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.219087; latitude: 22.998432;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.218917; latitude: 22.998405;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.218719; latitude: 22.998419;" >
        </a-image>

        <a-image src="#arrow" rotation="-90 0 0" scale="1 1 1" side="double"
          gps-entity-place="longitude: 120.218523; latitude: 22.998437;" >
        </a-image> -->
        
        <!--副館館前-->
        <!-- <a-plane 
            gps-entity-place="longitude: 120.219270; latitude: 22.998821;" 
            scale="1 1 1" 
		        rotation="90 0 -90"
			      width="2" height="40" 
			      color="#FFFFFF"
            src="#arrow"
			      repeat = "1 30" 
            side="double">
        <a-plane 
            gps-entity-place="longitude: 120.219657; latitude: 22.998797;"   
            scale="1 1 1" 
		        rotation="0 0 -89"
			      width="2" height="40" 
			      color="#0000AA"
            src="#arrow"
			      repeat = "1 30" 
            side="double">
            </a-plane>
		    </a-plane> -->

        <!--家前-->

        <a-entity 
          gltf-model="#nav" 
          scale="10 10 10"
          gps-entity-place="longitude: 120.219635; latitude: 22.998484;"></a-entity>
      </a-entity>

      <a-entity 
        text="value: Hello World;"
        gps-entity-place="longitude: 120.21793515707928; latitude:23.008439768589962;"
        color="#0000AA;">
      </a-entity>

      <!-- a-frame "position" parameter to assign a y-value to change the height of the content. -->
      <!-- This value should be entered as meters above or below (if negative) the current camera height. -->
      <a-entity 
        id="Judy"
        blood="blood_type:AB-type; oxygen_level: low"
        text="value: Hello World;"
        gps-entity-place="longitude: 120.21793515707928; latitude:23.008439768589962;"
        position="0 30 0"
        color="#0000AA;">
      </a-entity>

      <a-entity 
        id="Tank"
        blood="blood_type:A-type; oxygen_level: heigh"
        geometry="primitive: sphere" 
        material="color: red"
        gps-entity-place="longitude: 120.217975; latitude: 23.008345;" 
        position="0 30 0"
			  radius="0.3" >
      </a-entity>

        <!--position="-14.5 15 0"-->
        <!--不能以中文字-->
        <a-text 
          value="My home"
          side="double;"
          gps-entity-place="longitude: 120.217975; latitude: 23.008345;">
        </a-text>

        <a-text 
          value="Kaiyuan Elementary School" 
          side="double"
          gps-entity-place="longitude: 120.217901; latitude: 23.008287;">
        </a-text>
         
        <a-text 
          value="geomatics" 
          color="#0000AA"
          scale="15 15 15"
          side="double"
          gps-entity-place="longitude: 120.21999459727598; latitude: 22.998706010448853;">
        </a-text>

        <a-sphere 
          gps-entity-place="longitude: 120.21999459727598; latitude: 22.998706010448853;"
			    radius="0.3" 
			    color="#EF2D5E">
		    </a-sphere>

        <!-- <a-text 
          value="geomatics2" 
          color="#00AA00"
          scale="10 10 10"
          side="double"
          gps-entity-place="longitude: 120.219265; latitude: 22.998846;">
        </a-text> -->

        <a-text 
          value="Department of MATH" 
          scale="5 5 5"
          color="#FFFFF"
          side="double"
          gps-entity-place="longitude: 120.21935984659088; latitude: 22.998651691398333;">
        </a-text>

        <a-text 
          value="Department of Chemistry" 
          scale="5 5 5"
          color="#FFFFF"
          side="double"
          gps-entity-place="longitude: 120.21970910424058; latitude: 22.99816028155562;">
        </a-text>

        <a-entity 
          gltf-model="#articuno" 
          scale="0.05 0.05 0.05"
          gps-entity-place="longitude: 120.220013; latitude: 22.998374;">
        </a-entity>

        <a-camera id="camera" gps-camera rotation-reader><a-cursor></a-cursor></a-camera>
        <!--畫面中間的小圓點  -->
	</a-scene>

  <script>
    document.getElementById('clickme').onclick = function(e) {
      // e = Mouse click event.
      let rect = e.target.getBoundingClientRect();
      let x = e.clientX - rect.left; //x position within the element.
      let y = e.clientY - rect.top;  //y position within the element.
      let ax = -50+y*7/9 -180.730 ;
      let az = 350-x*7/9-50 - 27.659;
      console.log(x, ax)
      const cam = document.querySelector("#camera");
      cam.setAttribute("position", `${ax} ${cam.getAttribute("position").y} ${az}`);
    }

    function createInfoBoard(itemPos, textArr) {
      let userRot = getCamRot();
      let enti = document.createElement("a-entity");
      document.querySelector("a-scene").appendChild(enti);
      enti.setAttribute("class", "tarInfo");
      enti.setAttribute("color", "white");
      enti.setAttribute("position", {
        x: itemPos["x"] -2*Math.cos(Math.PI*userRot[1]/180),
        y: itemPos["y"] + 2,
        z: itemPos["z"] +2*Math.sin(Math.PI*userRot[1]/180),
      });
      
      enti.setAttribute("rotation", { x: 0, y: userRot[1], z: 0 });
      let box = document.createElement("a-box");
      document.querySelector(".tarInfo").appendChild(box);
      box.setAttribute("color", "white");
      box.setAttribute("height", 2);
      box.setAttribute("width", 3);
      box.setAttribute("depth", "0.025");

      let textPrefix = "anchor: center; width: 2; color: black; value: ";
      let text = document.createElement("a-text");
      for (let item of textArr) {
        textPrefix += item + "\n";
      }
      document.querySelector(".tarInfo").appendChild(text);
      text.setAttribute("position", { x: 0, y: 0, z: 0.025 });
      text.setAttribute("width", 30);
      text.setAttribute("text", textPrefix);
      text.setAttribute("wrap-count", 20);
    }
  </script>

  <div id="viewDiv"></div>
	  <script>  
		require([
		  "esri/Map",
		  "esri/views/MapView",      
		  "esri/Graphic",
		  "esri/tasks/RouteTask",
		  "esri/tasks/support/RouteParameters",
		  "esri/tasks/support/FeatureSet"
		], function(Map, MapView, Graphic, RouteTask, RouteParameters, FeatureSet) {

		  var map = new Map({
			basemap: "streets-navigation-vector"
		  });
		  
		  var view = new MapView({
			container: "viewDiv",
			map: map,
			center: [120.220061,22.998489],
			zoom: 16
		  });
		  
		  // To allow access to the route service and prevent the user from signing in, do the Challenge step in the lab to set up a service proxy
		  
		  var routeTask = new RouteTask({
			//需要登入
			//url: "https://utility.arcgis.com/usrsvcs/appservices/B6oRUZRf1bhrzrxF/rest/services/World/Route/NAServer/Route_World"
			//不用登入
			url: "https://utility.arcgis.com/usrsvcs/appservices/s1Y0qg8DGC9UdGsf/rest/services/World/Route/NAServer/Route_World/solve"
		  });

		  view.on("click", function(event){
			if (view.graphics.length === 0) {
			  addGraphic("start", event.mapPoint);
			} else if (view.graphics.length === 1) {
			  addGraphic("finish", event.mapPoint);
			  // Call the route service
			  getRoute();
			} else {
			  view.graphics.removeAll();
			  addGraphic("start",event.mapPoint);
			}
		  });
		  
		  function addGraphic(type, point) {
			var graphic = new Graphic({
			  symbol: {
				type: "simple-marker",
				color: (type === "start") ? "white" : "black",
				size: "8px"
			  },
			  geometry: point
			});
			view.graphics.add(graphic);
		  }
		
		  function getRoute() {
			// Setup the route parameters
			var routeParams = new RouteParameters({
			  stops: new FeatureSet({
				features: view.graphics.toArray()
			  }),
			  returnDirections: true
			});
			// Get the route
			routeTask.solve(routeParams).then(function(data) {
			  data.routeResults.forEach(function(result) {
				result.route.symbol = {
				  type: "simple-line",
				  color: [5, 150, 255],
				  width: 3
				};
				view.graphics.add(result.route); 
			  });
			  
			});
		  }
		  
		});
	  </script>
    
</body>
</html>